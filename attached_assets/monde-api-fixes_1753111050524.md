# CorreÃ§Ãµes para IntegraÃ§Ã£o com API do Monde

## 1. Adicionar Debug e Tratamento de Erros no Frontend

### Settings.tsx - Adicione logging e tratamento de erros:

```typescript
// No inÃ­cio do componente, adicione:
useEffect(() => {
  console.log('ğŸ” Settings component mounted');
  console.log('ğŸ” Token presente:', !!localStorage.getItem('keeptur-token'));
}, []);

// Modifique a funÃ§Ã£o loadUserProfile:
const loadUserProfile = async () => {
  try {
    const token = localStorage.getItem('keeptur-token');
    console.log('ğŸ” Token:', token ? 'Presente' : 'Ausente');
    
    if (!token) {
      console.error('âŒ Token nÃ£o encontrado');
      showToast('âŒ FaÃ§a login novamente', 'error');
      setLocation('/login');
      return;
    }
    
    const response = await fetch('/api/monde/user-profile', {
      headers: {
        Authorization: `Bearer ${token}`,
      },
    });
    
    console.log('ğŸ“¡ Response status:', response.status);
    
    if (response.ok) {
      const data = await response.json();
      console.log('âœ… Dados recebidos:', data);
      
      // Verificar estrutura dos dados
      if (!data || (!data.data && !data.attributes)) {
        console.error('âŒ Estrutura de dados invÃ¡lida:', data);
        showToast('âŒ Dados do perfil em formato invÃ¡lido', 'error');
        return;
      }
      
      // Mapear dados corretamente
      const attributes = data.data?.attributes || data.attributes || {};
      console.log('ğŸ“‹ Atributos extraÃ­dos:', attributes);
      
      setProfileData({
        // ... resto do mapeamento
      });
    } else if (response.status === 401) {
      // Token expirado
      console.error('âŒ Token expirado');
      showToast('âŒ SessÃ£o expirada. FaÃ§a login novamente.', 'error');
      setTimeout(() => {
        logout();
        setLocation('/login');
      }, 2000);
    } else {
      const errorText = await response.text();
      console.error('âŒ Erro na resposta:', response.status, errorText);
      showToast(`âŒ Erro ao carregar perfil: ${response.status}`, 'error');
    }
  } catch (error) {
    console.error('âŒ Erro ao carregar perfil:', error);
    showToast('âŒ Erro de conexÃ£o ao carregar perfil', 'error');
  }
};
```

## 2. CorreÃ§Ãµes no Backend (routes.ts)

### Adicione verificaÃ§Ã£o de token e melhor tratamento de erros:

```typescript
// Melhore o middleware authenticateToken:
const authenticateToken = async (req: any, res: any, next: any) => {
  const authHeader = req.headers.authorization;
  const token = authHeader && authHeader.split(" ")[1];

  console.log('ğŸ” Verificando token:', token ? 'Presente' : 'Ausente');

  if (!token) {
    return res.status(401).json({ message: "Token nÃ£o fornecido" });
  }

  try {
    const decoded = jwt.verify(token, JWT_SECRET) as any;
    console.log('ğŸ” Token decodificado:', decoded);
    
    if (!decoded.sessaoId) {
      console.error('âŒ Token sem sessaoId');
      return res.status(401).json({ message: "Token invÃ¡lido - sem sessaoId" });
    }

    const sessao = await storage.getSessao(decoded.sessaoId);
    console.log('ğŸ“‹ SessÃ£o encontrada:', sessao ? 'Sim' : 'NÃ£o');
    
    if (!sessao) {
      return res.status(401).json({ message: "SessÃ£o nÃ£o encontrada" });
    }

    // Verificar se token do Monde ainda Ã© vÃ¡lido
    if (sessao.expires_at && sessao.expires_at < new Date()) {
      console.log("âŒ Token do Monde expirado");
      await storage.deleteSessao(decoded.sessaoId);
      return res.status(401).json({ message: "Token expirado" });
    }

    console.log('âœ… AutenticaÃ§Ã£o bem-sucedida');
    req.sessao = sessao;
    req.empresaId = decoded.empresaId;
    req.user = {
      empresa_info: {
        id: decoded.empresaId
      }
    };
    req.mondeToken = sessao.access_token;
    next();
  } catch (error) {
    console.error('âŒ Erro na autenticaÃ§Ã£o:', error.message);
    return res.status(401).json({ message: "Token invÃ¡lido" });
  }
};

// Corrija o endpoint user-profile:
app.get('/api/monde/user-profile', authenticateToken, async (req: any, res) => {
  try {
    console.log('ğŸ” Buscando perfil do usuÃ¡rio...');
    console.log('ğŸ” Token Monde:', req.mondeToken ? 'Presente' : 'Ausente');
    
    // Primeiro, tente buscar dados do usuÃ¡rio logado
    const meResponse = await fetch('https://web.monde.com.br/api/v2/me', {
      headers: {
        'Authorization': `Bearer ${req.mondeToken}`,
        'Accept': 'application/vnd.api+json',
        'User-Agent': 'Keeptur/1.0'
      }
    });

    console.log('ğŸ“¡ Response /me:', meResponse.status);

    if (meResponse.ok) {
      const meData = await meResponse.json();
      console.log('âœ… Dados /me recebidos:', meData);
      
      // Se o endpoint /me retornar dados
      if (meData.data) {
        return res.json(meData);
      }
    }

    // Se falhar, buscar via people
    console.log('âš ï¸ Tentando via /people...');
    
    const peopleResponse = await fetch('https://web.monde.com.br/api/v2/people?page[size]=100', {
      headers: {
        'Authorization': `Bearer ${req.mondeToken}`,
        'Accept': 'application/vnd.api+json',
        'User-Agent': 'Keeptur/1.0'
      }
    });

    console.log('ğŸ“¡ Response /people:', peopleResponse.status);

    if (peopleResponse.ok) {
      const peopleData = await peopleResponse.json();
      const people = peopleData.data || [];
      
      console.log(`âœ… ${people.length} pessoas encontradas`);
      
      // Buscar usuÃ¡rio atual pelos dados da sessÃ£o
      const sessao = req.sessao;
      const userEmail = sessao?.user_data?.email;
      const userLogin = sessao?.user_data?.login;
      
      console.log('ğŸ” Procurando por:', { userEmail, userLogin });
      
      const currentUser = people.find((person: any) => {
        const attrs = person.attributes;
        return (
          attrs?.email === userEmail ||
          attrs?.login === userLogin ||
          attrs?.name?.toLowerCase().includes(userLogin?.toLowerCase())
        );
      });

      if (currentUser) {
        console.log('âœ… UsuÃ¡rio encontrado:', currentUser.attributes.name);
        return res.json({
          data: currentUser
        });
      }
    }

    // Fallback: retornar dados da sessÃ£o
    console.log('âš ï¸ Usando dados da sessÃ£o como fallback');
    const userData = req.sessao?.user_data || {};
    
    res.json({
      data: {
        type: 'people',
        attributes: {
          name: userData.name || 'UsuÃ¡rio',
          email: userData.email || '',
          phone: userData.phone || '',
          'mobile-phone': userData.mobilePhone || userData.mobile_phone || '',
          'business-phone': userData.businessPhone || userData.business_phone || '',
          cpf: userData.cpf || '',
          rg: userData.rg || '',
          'birth-date': userData.birthDate || userData.birth_date || '',
          gender: userData.gender || '',
          'company-name': userData.companyName || userData.company_name || '',
          cnpj: userData.cnpj || '',
          address: userData.address || '',
          number: userData.number || '',
          complement: userData.complement || '',
          district: userData.district || '',
          zip: userData.zip || '',
          observations: userData.observations || '',
          website: userData.website || ''
        }
      }
    });
    
  } catch (error) {
    console.error('âŒ Erro ao buscar perfil:', error);
    res.status(500).json({ 
      error: 'Erro interno do servidor',
      message: error.message 
    });
  }
});
```

## 3. Adicione CORS Headers (se necessÃ¡rio)

No seu servidor Express, adicione:

```typescript
app.use((req, res, next) => {
  res.header('Access-Control-Allow-Origin', '*');
  res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
  res.header('Access-Control-Allow-Headers', 'Origin, X-Requested-With, Content-Type, Accept, Authorization');
  
  if (req.method === 'OPTIONS') {
    res.sendStatus(200);
  } else {
    next();
  }
});
```

## 4. Teste de ConexÃ£o

Crie um endpoint de teste para verificar a conexÃ£o com a API do Monde:

```typescript
app.get('/api/test/monde-connection', authenticateToken, async (req: any, res) => {
  try {
    console.log('ğŸ§ª Testando conexÃ£o com Monde...');
    
    // Teste 1: Token info
    const tokenResponse = await fetch('https://web.monde.com.br/api/v2/tokens', {
      headers: {
        'Authorization': `Bearer ${req.mondeToken}`,
        'Accept': 'application/vnd.api+json'
      }
    });
    
    const tokenStatus = {
      endpoint: '/tokens',
      status: tokenResponse.status,
      ok: tokenResponse.ok
    };
    
    // Teste 2: Me endpoint
    const meResponse = await fetch('https://web.monde.com.br/api/v2/me', {
      headers: {
        'Authorization': `Bearer ${req.mondeToken}`,
        'Accept': 'application/vnd.api+json'
      }
    });
    
    const meStatus = {
      endpoint: '/me',
      status: meResponse.status,
      ok: meResponse.ok
    };
    
    // Teste 3: People endpoint
    const peopleResponse = await fetch('https://web.monde.com.br/api/v2/people?page[size]=1', {
      headers: {
        'Authorization': `Bearer ${req.mondeToken}`,
        'Accept': 'application/vnd.api+json'
      }
    });
    
    const peopleStatus = {
      endpoint: '/people',
      status: peopleResponse.status,
      ok: peopleResponse.ok
    };
    
    res.json({
      success: true,
      tests: {
        token: tokenStatus,
        me: meStatus,
        people: peopleStatus
      },
      sessionInfo: {
        hasToken: !!req.mondeToken,
        userData: req.sessao?.user_data
      }
    });
    
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});
```

## 5. Debugging no Frontend

Adicione um botÃ£o de teste no Settings.tsx:

```typescript
// Adicione esta funÃ§Ã£o
const testMondeConnection = async () => {
  try {
    const response = await fetch('/api/test/monde-connection', {
      headers: {
        Authorization: `Bearer ${localStorage.getItem('keeptur-token')}`,
      },
    });
    
    const data = await response.json();
    console.log('ğŸ§ª Teste de conexÃ£o:', data);
    
    if (data.success) {
      showToast('âœ… ConexÃ£o com Monde OK', 'success');
    } else {
      showToast('âŒ Falha na conexÃ£o com Monde', 'error');
    }
  } catch (error) {
    console.error('âŒ Erro no teste:', error);
    showToast('âŒ Erro ao testar conexÃ£o', 'error');
  }
};

// No JSX, adicione:
{currentTab === 'profile' && (
  <button
    onClick={testMondeConnection}
    className="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 ml-2"
  >
    Testar ConexÃ£o
  </button>
)}
```

## 6. VerificaÃ§Ã£o de Token no Login

Certifique-se de que o token estÃ¡ sendo salvo corretamente apÃ³s o login:

```typescript
// No componente de Login, apÃ³s receber a resposta:
if (response.ok) {
  const data = await response.json();
  console.log('âœ… Login bem-sucedido, salvando token...');
  localStorage.setItem('keeptur-token', data.token);
  console.log('ğŸ” Token salvo:', data.token);
  // ... resto do cÃ³digo
}
```
