Perfeito, segue abaixo o cÃ³digo completo com todas as correÃ§Ãµes para:

âœ… onSubmit da tarefa
âœ… salvarHistorico com tratamento de erro 415
âœ… payload com validaÃ§Ãµes seguras
âœ… Fechamento da modal mesmo com erro no histÃ³rico
ðŸ“¦ FunÃ§Ã£o onSubmit completa (para criaÃ§Ã£o/ediÃ§Ã£o de tarefas):
ts
Copiar
Editar
const onSubmit = async () => {
  try {
    setLoading(true);

    const payload = {
      name: tarefa.name || 'Tarefa sem nome',
      description: tarefa.description || '',
      due: tarefa.due || new Date().toISOString(),
      completed: tarefa.completed || false,
      status_id: tarefa.status?.id || statusPadraoId,
      person_id: tarefa.person?.id || null,
      company_id: tarefa.company?.id || usuario.company_id,
      category_id: tarefa.category?.id || null,
    };

    let response;
    if (tarefa.id) {
      // Editar tarefa existente
      response = await fetch(`/api/monde/tarefas/${tarefa.id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload),
      });
    } else {
      // Criar nova tarefa
      response = await fetch('/api/monde/tarefas', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload),
      });
    }

    const resultado = await response.json();

    if (!response.ok) {
      console.error('Erro ao salvar tarefa', resultado);
      alert('Erro ao salvar tarefa. Verifique os campos obrigatÃ³rios.');
      return;
    }

    const tarefaSalva = resultado?.data || resultado;
    console.log('ðŸ” Tarefa salva:', tarefaSalva);

    // Tentar salvar histÃ³rico, mesmo que falhe
    try {
      if (historicoTexto?.trim()) {
        await salvarHistorico(tarefaSalva.id, historicoTexto);
      }
    } catch (err) {
      console.warn('âš ï¸ HistÃ³rico nÃ£o salvo:', err);
    }

    // Atualiza lista de tarefas apÃ³s salvar
    await carregarTarefas();
    setIsModalAberta(false);
    setHistoricoTexto('');
    alert('Tarefa salva com sucesso!');
  } catch (error) {
    console.error('âŒ Erro inesperado:', error);
    alert('Erro inesperado ao salvar a tarefa.');
  } finally {
    setLoading(false);
  }
};
ðŸ“˜ FunÃ§Ã£o salvarHistorico com header correto
ts
Copiar
Editar
const salvarHistorico = async (taskId, texto) => {
  const response = await fetch(`/api/monde/tarefas/${taskId}/historico`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      description: texto,
    }),
  });

  if (!response.ok) {
    const erro = await response.json();
    throw new Error(`Erro ${response.status}: ${erro.message || 'Erro ao salvar histÃ³rico'}`);
  }

  console.log('âœ… HistÃ³rico salvo com sucesso');
};
âœ¨ Dica extra: status padrÃ£o e proteÃ§Ã£o do status_id
ts
Copiar
Editar
const statusPadraoId = listaDeStatus.find(s => s.name === 'Novo')?.id || listaDeStatus[0]?.id || null;
