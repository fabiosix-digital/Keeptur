OrientaÃ§Ã£o CirÃºrgica - CorreÃ§Ã£o APENAS do Problema de Status
ğŸ¯ PROBLEMA ESPECÃFICO IDENTIFICADO
O sistema estÃ¡ funcionando bem, EXCETO na transiÃ§Ã£o de status entre:

ExcluÃ­da â†’ Pendente/Atrasada
Pendente/Atrasada â†’ ExcluÃ­da

ğŸ”§ CORREÃ‡ÃƒO PONTUAL (SEM QUEBRAR O RESTO)
1. CORRIGIR APENAS a funÃ§Ã£o isTaskDeleted()
typescript// NO Dashboard.tsx - SUBSTITUIR a funÃ§Ã£o isTaskDeleted por:

const isTaskDeleted = (task: any) => {
  // PRIMEIRO: Verificar campos diretos da API do Monde
  if (task.attributes?.deleted === true || 
      task.attributes?.is_deleted === true ||
      task.attributes?.status === 'deleted' ||
      task.attributes?.archived === true) {
    return true;
  }
  
  // SEGUNDO: Verificar se tem histÃ³rico de exclusÃ£o SEM restauraÃ§Ã£o posterior
  if (task.historics && Array.isArray(task.historics)) {
    const hasDeleted = task.historics.some((h: any) => 
      (h.attributes?.text || h.text || '').includes('KEEPTUR_DELETED') ||
      (h.attributes?.text || h.text || '').includes('excluÃ­do')
    );
    
    const hasRestored = task.historics.some((h: any) => 
      (h.attributes?.text || h.text || '').includes('KEEPTUR_RESTORED') ||
      (h.attributes?.text || h.text || '').includes('restaurad')
    );
    
    // Se foi excluÃ­da E nÃ£o foi restaurada = estÃ¡ excluÃ­da
    if (hasDeleted && !hasRestored) {
      return true;
    }
  }
  
  return false; // Por padrÃ£o, considerar ativa
};
2. CORRIGIR APENAS a funÃ§Ã£o handleStatusChange()
typescript// SUBSTITUIR apenas a parte de detecÃ§Ã£o de restauraÃ§Ã£o:

const handleStatusChange = async () => {
  if (!statusChangeModal.task) return;

  try {
    const token = localStorage.getItem('keeptur-token');
    const task = statusChangeModal.task;
    const newStatus = statusChangeModal.newStatus;
    
    // âœ… CORREÃ‡ÃƒO: Detectar se Ã© restauraÃ§Ã£o corretamente
    const isCurrentlyDeleted = isTaskDeleted(task);
    const isRestoration = isCurrentlyDeleted && (newStatus === "pending" || newStatus === "overdue");
    
    // ValidaÃ§Ãµes existentes...
    
    let endpoint, method;
    let requestBody = {
      title: task.attributes?.title || "",
      description: task.attributes?.description || "",
      completed: newStatus === "completed"
    };

    if (statusChangeForm.datetime) {
      requestBody.due = new Date(statusChangeForm.datetime).toISOString();
    }

    // âœ… CORREÃ‡ÃƒO: Escolher endpoint correto baseado no estado real
    if (isRestoration) {
      // Para tarefas que ESTÃƒO excluÃ­das e vÃ£o ser restauradas
      endpoint = `/api/monde/tarefas/${task.id}/restore`;
      method = 'POST';
      requestBody.historic = statusChangeForm.comment || 'Tarefa restaurada via interface';
      console.log("ğŸ”„ Usando endpoint de RESTAURAÃ‡ÃƒO");
    } else if (newStatus === 'archived') {
      // Para arquivar/excluir tarefa ativa
      endpoint = `/api/monde/tarefas/${task.id}`;
      method = 'DELETE';
      console.log("ğŸ—‘ï¸ Usando endpoint de EXCLUSÃƒO");
    } else {
      // Para outras mudanÃ§as normais de status
      endpoint = `/api/monde/tarefas/${task.id}`;
      method = 'PUT';
      console.log("ğŸ“ Usando endpoint de ATUALIZAÃ‡ÃƒO");
    }

    // Fazer requisiÃ§Ã£o...
    const response = await fetch(endpoint, {
      method,
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`,
      },
      body: method !== 'DELETE' ? JSON.stringify(requestBody) : undefined,
    });

    if (response.ok) {
      // âœ… FORÃ‡AR recarregamento apÃ³s mudanÃ§a
      setTimeout(() => {
        reloadTasks();
        checkForChanges(); // ForÃ§ar sincronizaÃ§Ã£o
      }, 500);
      
      setStatusChangeForm(prev => ({ ...prev, success: "Status alterado com sucesso!" }));
      
      // Fechar modal apÃ³s 1 segundo
      setTimeout(() => {
        setStatusChangeModal({ isOpen: false, task: null, newStatus: "", isReopen: false });
        setStatusChangeForm({ datetime: "", comment: "", success: "", error: "" });
      }, 1000);
    }

  } catch (error) {
    console.error("âŒ Erro ao alterar status:", error);
    setStatusChangeForm(prev => ({ ...prev, error: `Erro: ${error.message}` }));
  }
};
3. GARANTIR que o backend tenha o endpoint correto
typescript// NO server.ts - VERIFICAR se existe o endpoint de restore:

app.post("/api/monde/tarefas/:id/restore", authenticateToken, async (req: any, res) => {
  try {
    const taskId = req.params.id;
    const mondeUrl = `https://web.monde.com.br/api/v2/tasks/${taskId}`;
    
    const requestBody = {
      data: {
        type: "tasks",
        id: taskId,
        attributes: {
          title: req.body.title,
          description: req.body.description || '',
          due: req.body.due,
          completed: false // SEMPRE false para restauraÃ§Ã£o
        }
      }
    };
    
    const mondeResponse = await fetch(mondeUrl, {
      method: "PUT",
      headers: {
        "Content-Type": "application/vnd.api+json",
        "Accept": "application/vnd.api+json",
        "Authorization": `Bearer ${req.sessao.access_token}`,
      },
      body: JSON.stringify(requestBody),
    });

    if (mondeResponse.ok) {
      const data = await mondeResponse.json();
      
      // Adicionar histÃ³rico de restauraÃ§Ã£o
      const historyText = `ğŸ”„ KEEPTUR_RESTORED - ${req.body.historic || 'Tarefa restaurada'}`;
      
      await fetch(`https://web.monde.com.br/api/v2/task-historics`, {
        method: "POST",
        headers: {
          "Content-Type": "application/vnd.api+json",
          "Accept": "application/vnd.api+json",
          "Authorization": `Bearer ${req.sessao.access_token}`,
        },
        body: JSON.stringify({
          data: {
            type: "task-historics",
            attributes: {
              text: historyText,
              "date-time": new Date().toISOString()
            },
            relationships: {
              task: {
                data: { type: "tasks", id: taskId }
              }
            }
          }
        }),
      });
      
      res.json(data);
    } else {
      const errorText = await mondeResponse.text();
      res.status(mondeResponse.status).json({ error: errorText });
    }
    
  } catch (error) {
    console.error("Erro ao restaurar tarefa:", error);
    res.status(500).json({ error: "Erro interno" });
  }
});
4. CORRIGIR apenas a detecÃ§Ã£o no drag and drop
typescript// Na funÃ§Ã£o handleDrop - SUBSTITUIR apenas a parte de detecÃ§Ã£o:

const handleDrop = async (e: React.DragEvent, newStatus: string) => {
  // ... cÃ³digo existente atÃ© a parte de detecÃ§Ã£o ...
  
  // âœ… CORREÃ‡ÃƒO: Usar a funÃ§Ã£o isTaskDeleted corrigida
  const taskIsCurrentlyDeleted = isTaskDeleted(taskData);
  const isRestoringDeletedTask = taskIsCurrentlyDeleted && 
    (newStatus === "pending" || newStatus === "overdue");
  
  // Se for restauraÃ§Ã£o OU reativaÃ§Ã£o de concluÃ­da
  if (isRestoringDeletedTask || 
      ((currentStatus === "completed" || currentStatus === "archived") && 
       (newStatus === "pending" || newStatus === "overdue"))) {
    
    const actionType = isRestoringDeletedTask ? "restauraÃ§Ã£o de tarefa excluÃ­da" : "reativaÃ§Ã£o de tarefa";
    console.log(`ğŸ”„ ${actionType} detectada`);
    
    setStatusChangeModal({
      isOpen: true,
      task: taskData,
      newStatus,
      isReopen: true
    });
    
    return; // Abrir modal para coletar dados
  }

  // ... resto do cÃ³digo existente ...
};
ğŸ¯ RESUMO DA CORREÃ‡ÃƒO
O QUE MUDA:

âœ… FunÃ§Ã£o isTaskDeleted() - detecta corretamente tarefas excluÃ­das
âœ… FunÃ§Ã£o handleStatusChange() - escolhe endpoint correto para restauraÃ§Ã£o
âœ… FunÃ§Ã£o handleDrop() - detecta corretamente quando Ã© restauraÃ§Ã£o
âœ… Endpoint /restore no backend - garante restauraÃ§Ã£o correta

O QUE NÃƒO MUDA:

âœ… Layout permanece intacto
âœ… Outras funcionalidades continuam funcionando
âœ… Sistema de filtros permanece igual
âœ… LÃ³gica de sincronizaÃ§Ã£o permanece igual
âœ… Interface e design permanecem iguais

