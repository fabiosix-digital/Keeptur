Com base nos seus logs e nos arquivos analisados, encontrei os pontos crÃ­ticos que explicam por que:

os dados de cliente (nome, telefone, celular e empresa) nÃ£o aparecem corretamente

as atualizaÃ§Ãµes nÃ£o aparecem no histÃ³rico

e o botÃ£o â€œsalvarâ€ nÃ£o estÃ¡ funcionando como esperado.

âœ… 1. Por que os dados do cliente (pessoa) nÃ£o aparecem?
A falha estÃ¡ em como a tarefa tenta buscar os dados relacionados Ã  pessoa.

O ID da pessoa estÃ¡ vindo corretamente da tarefa.relationships.person.data.id, mas o componente que deveria buscar os dados completos dessa pessoa (nome, telefone, etc.) nÃ£o encontra esse ID na lista de pessoas carregadas.

Ou seja:

tsx
Copiar
Editar
const pessoa = pessoas.find((p) => p.id === task?.relationships?.person?.data?.id)
â†’ Aqui o p.id nunca bate com o task.relationships.person.data.id porque:

ou o id estÃ¡ em outro formato (por exemplo: com "pessoas-" ou uuid puro)

ou os pessoas carregados ainda nÃ£o chegaram no momento da renderizaÃ§Ã£o

âœ… 2. Telefone e celular nÃ£o aparecem?
Isso depende diretamente do pessoa.attributes. Se a pessoa nÃ£o foi encontrada como explicado acima, os campos ficam em branco:

tsx
Copiar
Editar
pessoa?.attributes?.phone
pessoa?.attributes?.mobile
âœ… 3. Empresa nÃ£o aparece?
Mesmo problema. O sistema tenta buscar a empresa com:

tsx
Copiar
Editar
const empresa = empresas.find((e) => e.id === pessoa?.relationships?.empresa?.data?.id)
Se a pessoa nÃ£o foi carregada corretamente, isso aqui tambÃ©m falha em cascata.

âœ… 4. HistÃ³rico nÃ£o salva corretamente e mostra dados de outras tarefas?
A funÃ§Ã£o que carrega os histÃ³ricos:

tsx
Copiar
Editar
const historicoTarefa = historicos.filter((h) => h.relationships?.task?.data?.id === task.id)
EstÃ¡ puxando todos os histÃ³ricos do sistema, e depois filtrando localmente. Mas se os histÃ³ricos carregados vÃªm de forma global, e a tarefa ainda nÃ£o foi salva corretamente, esse task.id pode nÃ£o estar registrado ainda no histÃ³rico.

AlÃ©m disso, o campo de histÃ³rico atualizado via mutation pode estar salvando, mas o frontend nÃ£o estÃ¡ refetchando os dados apÃ³s o mutate() â€” por isso vocÃª vÃª a mensagem âœ… HistÃ³rico salvo com sucesso mas nada muda visualmente.

âœ… 5. BotÃ£o "Salvar" nÃ£o fecha o modal nem atualiza os campos?
Isso estÃ¡ associado ao handleSave:

O mutate deve ser assÃ­ncrono, e sÃ³ depois que a mutation for bem-sucedida, a modal deve fechar.

Se nÃ£o houver await ou callback de sucesso, o modal permanece aberto e o frontend nÃ£o reflete as mudanÃ§as.

âœ… CorreÃ§Ãµes recomendadas
ðŸ›  1. Corrigir busca da pessoa
Substituir:

tsx
Copiar
Editar
const pessoa = pessoas.find((p) => p.id === task?.relationships?.person?.data?.id)
Por algo mais robusto que compare o ID padronizado:

tsx
Copiar
Editar
const pessoaId = task?.relationships?.person?.data?.id
const pessoa = pessoas.find((p) => p.id?.toString() === pessoaId?.toString())
Ou usar .includes() se o id vier com prefixo tipo "pessoas-123".

ðŸ›  2. ForÃ§ar refetch dos histÃ³ricos apÃ³s salvar
tsx
Copiar
Editar
mutate(data, {
  onSuccess: () => {
    refetchHistoricos()
    fecharModal()
  }
})
ðŸ›  3. Garantir que empresas estejam carregadas antes de renderizar
VocÃª pode condicionar o rendering com:

tsx
Copiar
Editar
if (!pessoas.length || !empresas.length || !task) return <Loading />
ðŸ›  4. Validar se task.relationships.person.data.id Ã© realmente o mesmo tipo de p.id
Verifique no console se os valores sÃ£o compatÃ­veis, ou normalize ambos os lados antes de comparar.

Se quiser, posso te entregar agora:

o trecho exato corrigido da busca de pessoa + telefone + empresa

o handleSave completo com fechamento automÃ¡tico do modal

o refetch de histÃ³rico sincronizado

SÃ³ confirmar que eu monto o cÃ³digo pronto agora.








VocÃª disse:
faÃ§a isso


O ChatGPT disse:
Perfeito. Abaixo estÃ¡ o que vocÃª precisa para corrigir todos os problemas mencionados: busca correta do cliente, empresa, telefone, celular, histÃ³rico e salvamento com fechamento do modal.

âœ… 1. CorreÃ§Ã£o da busca da pessoa (cliente)
Substitua o trecho onde vocÃª encontra a pessoa associada Ã  tarefa:

ANTES
tsx
Copiar
Editar
const pessoa = pessoas.find((p) => p.id === task?.relationships?.person?.data?.id)
DEPOIS
tsx
Copiar
Editar
const pessoaId = task?.relationships?.person?.data?.id?.toString() || ''
const pessoa = pessoas.find((p) => p.id?.toString() === pessoaId)
âœ… 2. Busca correta da empresa vinculada Ã  pessoa
Substitua:

tsx
Copiar
Editar
const empresa = empresas.find((e) => e.id === pessoa?.relationships?.empresa?.data?.id)
Por:

tsx
Copiar
Editar
const empresaId = pessoa?.relationships?.empresa?.data?.id?.toString() || ''
const empresa = empresas.find((e) => e.id?.toString() === empresaId)
âœ… 3. Exibir corretamente nome, telefone, celular e empresa
tsx
Copiar
Editar
<p><strong>Cliente:</strong> {pessoa?.attributes?.name || 'Sem nome'}</p>
<p><strong>Telefone:</strong> {pessoa?.attributes?.phone || 'Sem telefone'}</p>
<p><strong>Celular:</strong> {pessoa?.attributes?.mobile || 'Sem celular'}</p>
<p><strong>Empresa:</strong> {empresa?.attributes?.name || 'Sem empresa'}</p>
âœ… 4. Salvar tarefa e atualizar histÃ³rico com fechamento do modal
Aqui estÃ¡ o onSubmit completo corrigido:

tsx
Copiar
Editar
const onSubmit = async () => {
  try {
    const response = await updateTarefaMutation.mutateAsync({
      id: task.id,
      ...formData // substitua por seus campos reais
    })

    console.log('âœ… Tarefa atualizada com sucesso:', response)

    await createHistoricoMutation.mutateAsync({
      tarefaId: task.id,
      descricao: `AtualizaÃ§Ã£o feita: ${JSON.stringify(formData)}`
    })

    console.log('âœ… HistÃ³rico salvo com sucesso')

    await refetchTarefas()
    await refetchHistoricos()

    closeModal() // Feche o modal apenas apÃ³s tudo
  } catch (error) {
    console.error('âŒ Erro ao salvar tarefa ou histÃ³rico:', error)
  }
}
Se o updateTarefaMutation nÃ£o for assÃ­ncrono, use:

tsx
Copiar
Editar
updateTarefaMutation.mutate(data, {
  onSuccess: () => {
    createHistoricoMutation.mutate({
      tarefaId: task.id,
      descricao: `AtualizaÃ§Ã£o feita: ${JSON.stringify(formData)}`
    }, {
      onSuccess: () => {
        refetchTarefas()
        refetchHistoricos()
        closeModal()
      }
    })
  }
})
âœ… 5. Filtrar histÃ³rico da tarefa correta
tsx
Copiar
Editar
const historicoTarefa = historicos.filter(
  (h) => h.relationships?.task?.data?.id?.toString() === task.id?.toString()
)
Se quiser, posso revisar seu dashboard.tsx inteiro e aplicar isso diretamente